name: Build and push changed services

on:
  push:
    branches: [main, dev, update-ci-cd]
#  pull_request:
#    branches: [main, dev, update-ci-cd]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  determine-services:
    name: Determine services to build
    runs-on: ubuntu-latest
    outputs:
      services_json: ${{ steps.set.outputs.services_json }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine changed top-level dirs
        id: set
        run: |
          set -euo pipefail
          # Determine base ref: prefer pull_request base, otherwise previous commit
          if [ -n "${{ github.event.pull_request.head.sha || '' }}" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            BASE_REF="${{ github.sha }}~1"
          fi
          echo "BASE_REF=$BASE_REF"
          git fetch --no-tags --prune --depth=50 origin

          if ! git rev-parse --verify "$BASE_REF" >/dev/null 2>&1; then
            echo "First commit detected - building all services"
            SERVICES=$(find . -maxdepth 1 -type d ! -name '.' ! -name '..' ! -name '.git' ! -name '.github' ! -name 'infra' ! -name 'docs' ! -name 'contracts' ! -name 'http' ! -name 'scripts' ! -name 'target' -exec basename {} \; | tr '\n' ' ')
          else
            CHANGED_FILES=$(git diff --name-only "$BASE_REF" "${{ github.sha }}" || true)
            echo "Changed files:"
            echo "$CHANGED_FILES"
            SERVICES=$(echo "$CHANGED_FILES" | awk -F/ '{print $1}' | sort -u | tr '\n' ' ')

            FILTERED_SERVICES=""
            for svc in $SERVICES; do
              case "$svc" in
                .github|infra|docs|contracts|http|scripts|target|README.md|pom.xml)
                  ;;
                *)
                  FILTERED_SERVICES="$FILTERED_SERVICES $svc"
                  ;;
              esac
            done

            if [ -z "$FILTERED_SERVICES" ] && [ -n "$SERVICES" ]; then
              echo "Only non-service directories changed (likely adding CI/CD) - building all services"
              SERVICES=$(find . -maxdepth 1 -type d ! -name '.' ! -name '..' ! -name '.git' ! -name '.github' ! -name 'infra' ! -name 'docs' ! -name 'contracts' ! -name 'http' ! -name 'scripts' ! -name 'target' -exec basename {} \; | tr '\n' ' ')
            fi
          fi

          # Convert to a JSON array for the matrix
          python - <<'PY'
import json,sys,subprocess
svc_str = """$SERVICES"""
items = [s for s in svc_str.split() if s]
print(json.dumps(items))
PY
          | tee services.json

          SERVICES_JSON=$(cat services.json)
          echo "Services JSON: $SERVICES_JSON"
          echo "services_json=$SERVICES_JSON" >> $GITHUB_OUTPUT

  build-and-push:
    name: Build and push changed services (matrix)
    needs: determine-services
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.determine-services.outputs.services_json) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up JDK 17 and 21 (for possible pre-builds)
        uses: actions/setup-java@v4
        with:
          java-version: |
            17
            21
          distribution: "temurin"
          cache: "maven"

      - name: Build and push image for matrix service
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          SHORT_SHA: ${{ github.sha }}
          SERVICE: ${{ matrix.service }}
        run: |
          set -eu
          svc=${SERVICE}
          echo "Building service: $svc"

          if [ ! -d "$svc" ]; then
            echo "Skipping $svc: not a directory"
            exit 0
          fi

          if [ ! -f "$svc/Dockerfile" ] && [ ! -f "$svc/Dockerfile.prebuilt" ] && [ ! -f "$svc/docker/Dockerfile" ]; then
            echo "Skipping $svc: no Dockerfile found"
            exit 0
          fi

          # Pre-build Maven artifacts if Dockerfile.prebuilt is present
          if [ -f "$svc/pom.xml" ] && [ -f "$svc/Dockerfile.prebuilt" ]; then
            echo "Building Maven project for $svc (Dockerfile.prebuilt detected)"
            cd "$svc"
            if [ -f ./mvnw ]; then
              chmod +x ./mvnw
              ./mvnw clean package -DskipTests
            else
              mvn -q clean package -DskipTests
            fi
            cd -
          fi

          IMAGE_SHA=${DOCKERHUB_USERNAME}/${svc}:${SHORT_SHA::8}

          # Determine additional tags based on branch
          ADDITIONAL_TAGS=()
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            ADDITIONAL_TAGS+=(--tag ${DOCKERHUB_USERNAME}/${svc}:latest)
          elif [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            ADDITIONAL_TAGS+=(--tag ${DOCKERHUB_USERNAME}/${svc}:dev-latest)
          fi

          # Choose Dockerfile and determine build context
          DOCKERFILE=""
          BUILD_CONTEXT="."
          if [ -f "$svc/Dockerfile" ]; then
            DOCKERFILE="$svc/Dockerfile"
            if grep -q "COPY $svc/" "$DOCKERFILE" 2>/dev/null || grep -q "ADD $svc/" "$DOCKERFILE" 2>/dev/null; then
              BUILD_CONTEXT="."
            else
              BUILD_CONTEXT="$svc"
            fi
          elif [ -f "$svc/Dockerfile.prebuilt" ]; then
            DOCKERFILE="$svc/Dockerfile.prebuilt"
            BUILD_CONTEXT="$svc"
          elif [ -f "$svc/docker/Dockerfile" ]; then
            DOCKERFILE="$svc/docker/Dockerfile"
            BUILD_CONTEXT="$svc"
          fi

          CACHE_REF=${DOCKERHUB_USERNAME}/${svc}:cache

          echo "Using Dockerfile=$DOCKERFILE and context=$BUILD_CONTEXT"
          echo "Using cache ref: $CACHE_REF"

          # Build with buildx and push; use registry cache to avoid re-pulling common layers
          docker buildx build --platform linux/amd64 --push \
            --tag "$IMAGE_SHA" \
            ${ADDITIONAL_TAGS[@]:-} \
            --cache-from=type=registry,ref=$CACHE_REF \
            --cache-to=type=registry,ref=$CACHE_REF,mode=max \
            --file "$DOCKERFILE" \
            "$BUILD_CONTEXT"

          echo "Pushed images for $svc"
