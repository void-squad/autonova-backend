name: Test Report

on:
  workflow_run:
    workflows: ['Test and Coverage Report']
    types:
      - completed

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  # Report for Java services
  report-java-services:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'cancelled' }}
    strategy:
      fail-fast: false
      matrix:
        service:
          - analytics-service
          - appointment-booking-service
          - auth-service
          - chatbot
          - customer-service
          - discovery-service
          - employee-dashboard-service
          - gateway-service
          - notification-service
          - payments-billing-service
          - progress-monitoring-service
          - time-logging-service
    steps:
      - uses: dorny/test-reporter@v2
        with:
          artifact: test-results-${{ matrix.service }}
          name: 'Test Results - ${{ matrix.service }}'
          path: '**/*.xml'
          reporter: java-junit
          fail-on-error: false
          fail-on-empty: false
          only-summary: false
          list-suites: 'failed'
          list-tests: 'failed'
          max-annotations: 50
          badge-title: '${{ matrix.service }}'

  # Report for .NET services
  report-dotnet-services:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'cancelled' }}
    strategy:
      fail-fast: false
      matrix:
        service:
          - project-service
    steps:
      - uses: dorny/test-reporter@v2
        with:
          artifact: test-results-dotnet-${{ matrix.service }}
          name: 'Test Results - .NET - ${{ matrix.service }}'
          path: '**/*.trx'
          reporter: dotnet-trx
          fail-on-error: false
          fail-on-empty: false
          only-summary: false
          list-suites: 'failed'
          list-tests: 'failed'
          max-annotations: 50
          badge-title: '${{ matrix.service }}'

  # Combined summary report
  combined-report:
    runs-on: ubuntu-latest
    needs: [report-java-services, report-dotnet-services]
    if: ${{ always() && github.event.workflow_run.conclusion != 'cancelled' }}
    steps:
      - uses: dorny/test-reporter@v2
        with:
          # match artifacts created by the previous jobs; use a wildcard rather than regex
          artifact: 'test-results-*'
          name: 'Combined Test Report - All Services'
          # glob both JUnit XML and .trx files using brace expansion
          path: '**/*.{xml,trx}'
          # allow the action to auto-detect report formats (handles .trx + JUnit XML)
          reporter: auto
          fail-on-error: false
          fail-on-empty: false
          only-summary: true
          badge-title: 'All Services'
          report-title: 'üìä Complete Test Suite Results'

  # Status check
  report-status:
    runs-on: ubuntu-latest
    needs: [report-java-services, report-dotnet-services, combined-report]
    if: always()
    steps:
      - name: Check report status
        run: |
          echo "Java Services Report: ${{ needs.report-java-services.result }}"
          echo ".NET Services Report: ${{ needs.report-dotnet-services.result }}"
          echo "Combined Report: ${{ needs.combined-report.result }}"
          
          if [ "${{ needs.report-java-services.result }}" == "failure" ] || [ "${{ needs.report-dotnet-services.result }}" == "failure" ]; then
            echo "‚ö†Ô∏è Some test reports failed to generate"
            exit 0
          else
            echo "‚úÖ All test reports generated successfully"
            exit 0
          fi
