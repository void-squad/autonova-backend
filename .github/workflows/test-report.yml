name: Test Report

on:
  workflow_run:
    workflows: ['Test and Coverage Report']
    types:
      - completed

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  # Report for Java services
  report-java-services:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'cancelled' }}
    strategy:
      fail-fast: false
      matrix:
        service:
          - analytics-service
          - appointment-booking-service
          - auth-service
          - chatbot
          - customer-service
          - discovery-service
          - employee-dashboard-service
          - gateway-service
          - notification-service
          - payments-billing-service
          - progress-monitoring-service
          - time-logging-service
    steps:
      - name: 'Unit Test Results - ${{ matrix.service }}'
        uses: dorny/test-reporter@v2
        with:
          artifact: test-results-${{ matrix.service }}
          name: 'Unit Tests - ${{ matrix.service }}'
          # only include actual JUnit TEST-*.xml files (exclude summary files)
          path: '**/surefire-reports/TEST-*.xml'
          reporter: java-junit
          fail-on-error: false
          fail-on-empty: false
          only-summary: false
          list-suites: 'failed'
          list-tests: 'failed'
          max-annotations: 50
          badge-title: '${{ matrix.service }}'

      - name: 'Integration Test Results - ${{ matrix.service }}'
        uses: dorny/test-reporter@v2
        with:
          artifact: test-results-${{ matrix.service }}
          name: 'Integration Tests - ${{ matrix.service }}'
          # include only failing integration test result files generated by failsafe
          path: '**/failsafe-reports/TEST-*.xml'
          reporter: java-junit
          fail-on-error: false
          fail-on-empty: false
          only-summary: false
          list-suites: 'failed'
          list-tests: 'failed'
          max-annotations: 50
          badge-title: '${{ matrix.service }}'

  # Report for .NET services
  report-dotnet-services:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'cancelled' }}
    strategy:
      fail-fast: false
      matrix:
        service:
          - project-service
    steps:
      - uses: dorny/test-reporter@v2
        with:
          artifact: test-results-dotnet-${{ matrix.service }}
          name: 'Test Results - .NET - ${{ matrix.service }}'
          path: '**/*.trx'
          reporter: dotnet-trx
          fail-on-error: false
          fail-on-empty: false
          only-summary: false
          list-suites: 'failed'
          list-tests: 'failed'
          max-annotations: 50
          badge-title: '${{ matrix.service }}'

  # Combined summary report
  combined-report:
    runs-on: ubuntu-latest
    needs: [report-java-services, report-dotnet-services]
    if: ${{ always() && github.event.workflow_run.conclusion != 'cancelled' }}
    steps:
      - name: "Debug: list artifacts from triggering run"
        env:
          RUN_ID: ${{ github.event.workflow_run.id }}
        run: bash .github/scripts/list-artifacts.sh "$RUN_ID"

      - name: "Debug: show matching artifact files (first lines)"
        env:
          RUN_ID: ${{ github.event.workflow_run.id }}
        run: bash .github/scripts/inspect-artifacts.sh "$RUN_ID"

      - name: Download all test-results-* artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: 'test-results-*'
          path: ./test-results

      - name: Sanitize test result files (skip malformed XML/TRX)
        run: |
          set -eux
          python3 .github/scripts/sanitize-test-results.py

      - name: Generate combined test report from sanitized files
        uses: dorny/test-reporter@v2
        continue-on-error: true
        with:
          name: 'Combined Test Report - All Services'
          path: 'test-results-clean/**/*.{xml,trx}'
          reporter: auto
          fail-on-error: false
          fail-on-empty: false
          only-summary: true
          badge-title: 'All Services'
          report-title: 'üìä Complete Test Suite Results'

  # Status check
  report-status:
    runs-on: ubuntu-latest
    needs: [report-java-services, report-dotnet-services, combined-report]
    if: always()
    steps:
      - name: Check report status
        run: |
          echo "Java Services Report: ${{ needs.report-java-services.result }}"
          echo ".NET Services Report: ${{ needs.report-dotnet-services.result }}"
          echo "Combined Report: ${{ needs.combined-report.result }}"
          
          if [ "${{ needs.report-java-services.result }}" == "failure" ] || [ "${{ needs.report-dotnet-services.result }}" == "failure" ]; then
            echo "‚ö†Ô∏è Some test reports failed to generate"
            exit 0
          else
            echo "‚úÖ All test reports generated successfully"
            exit 0
          fi
