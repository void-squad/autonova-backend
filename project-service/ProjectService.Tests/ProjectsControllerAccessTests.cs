using System;using System.Collections.Generic;using System.Security.Claims;using System.Threading;using System.Threading.Tasks;using FluentAssertions;using Microsoft.AspNetCore.Http;using Microsoft.AspNetCore.Mvc;using Microsoft.EntityFrameworkCore;using ProjectService.Controllers;using ProjectService.Data;using ProjectService.Domain.Entities;using ProjectService.Domain.Enums;using ProjectService.Dtos;using ProjectService.Validators;using Xunit;namespace ProjectService.Tests;public class ProjectsControllerAccessTests{    private AppDb _db;    private ProjectsController _controller;    private ClaimsPrincipal _customer;    private ClaimsPrincipal _admin;    private ClaimsPrincipal _otherCustomer;    private ClaimsPrincipal _employee;    public ProjectsControllerAccessTests(){        var options = new DbContextOptionsBuilder<AppDb>().UseInMemoryDatabase(Guid.NewGuid().ToString()).Options;        _db = new AppDb(options);        _controller = new ProjectsController(_db, new CreateProjectRequestValidator());        _customer = new ClaimsPrincipal(new ClaimsIdentity(new[]{ new Claim("sub","100"), new Claim("role","customer") },"test"));        _admin = new ClaimsPrincipal(new ClaimsIdentity(new[]{ new Claim("sub","1"), new Claim("role","admin") },"test"));        _otherCustomer = new ClaimsPrincipal(new ClaimsIdentity(new[]{ new Claim("sub","200"), new Claim("role","customer") },"test"));        _employee = new ClaimsPrincipal(new ClaimsIdentity(new[]{ new Claim("sub","300"), new Claim("role","employee") },"test"));    }    private void SetUser(ClaimsPrincipal user){ _controller.ControllerContext = new ControllerContext{ HttpContext = new DefaultHttpContext{ User=user } }; }    [Fact]    public async Task GetProjectById_AllowsCustomerOwner(){        var p = new Project{ ProjectId=Guid.NewGuid(), CustomerId=100, VehicleId=Guid.NewGuid(), Title="P", Status=ProjectStatus.PendingReview, CreatedAt=DateTimeOffset.UtcNow, UpdatedAt=DateTimeOffset.UtcNow };        p.Tasks.Add(new ProjectTask{ TaskId=Guid.NewGuid(), ProjectId=p.ProjectId, Title="T", ServiceType="S", CreatedAt=DateTimeOffset.UtcNow, UpdatedAt=DateTimeOffset.UtcNow });        _db.Projects.Add(p);        await _db.SaveChangesAsync();        SetUser(_customer);        var resp = await _controller.GetProjectById(p.ProjectId, CancellationToken.None);        resp.Result.Should().BeOfType<OkObjectResult>();    }    [Fact]    public async Task GetProjectById_ForbidsOtherCustomer(){        var p = new Project{ ProjectId=Guid.NewGuid(), CustomerId=100, VehicleId=Guid.NewGuid(), Title="P", Status=ProjectStatus.PendingReview, CreatedAt=DateTimeOffset.UtcNow, UpdatedAt=DateTimeOffset.UtcNow };        p.Tasks.Add(new ProjectTask{ TaskId=Guid.NewGuid(), ProjectId=p.ProjectId, Title="T", ServiceType="S", AssigneeId=300, CreatedAt=DateTimeOffset.UtcNow, UpdatedAt=DateTimeOffset.UtcNow });        _db.Projects.Add(p);        await _db.SaveChangesAsync();        SetUser(_otherCustomer);        var resp = await _controller.GetProjectById(p.ProjectId, CancellationToken.None);        resp.Result.Should().BeOfType<ForbidResult>();    }    [Fact]    public async Task GetProjectById_AllowsEmployeeAssigned(){        var p = new Project{ ProjectId=Guid.NewGuid(), CustomerId=100, VehicleId=Guid.NewGuid(), Title="P", Status=ProjectStatus.PendingReview, CreatedAt=DateTimeOffset.UtcNow, UpdatedAt=DateTimeOffset.UtcNow };        p.Tasks.Add(new ProjectTask{ TaskId=Guid.NewGuid(), ProjectId=p.ProjectId, Title="T", ServiceType="S", AssigneeId=300, CreatedAt=DateTimeOffset.UtcNow, UpdatedAt=DateTimeOffset.UtcNow });        _db.Projects.Add(p);        await _db.SaveChangesAsync();        SetUser(_employee);        var resp = await _controller.GetProjectById(p.ProjectId, CancellationToken.None);        resp.Result.Should().BeOfType<OkObjectResult>();    }    [Fact]    public async Task GetProjectById_AllowsAdmin(){        var p = new Project{ ProjectId=Guid.NewGuid(), CustomerId=100, VehicleId=Guid.NewGuid(), Title="P", Status=ProjectStatus.PendingReview, CreatedAt=DateTimeOffset.UtcNow, UpdatedAt=DateTimeOffset.UtcNow };        _db.Projects.Add(p);        await _db.SaveChangesAsync();        SetUser(_admin);        var resp = await _controller.GetProjectById(p.ProjectId, CancellationToken.None);        resp.Result.Should().BeOfType<OkObjectResult>();    }}