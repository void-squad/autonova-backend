using System;using System.Collections.Generic;using System.Linq;using System.Security.Claims;using System.Threading;using System.Threading.Tasks;using FluentAssertions;using Microsoft.AspNetCore.Http;using Microsoft.AspNetCore.Mvc;using Microsoft.EntityFrameworkCore;using Moq;using ProjectService.Controllers;using ProjectService.Data;using ProjectService.Domain.Entities;using ProjectService.Domain.Enums;using ProjectService.Dtos;using ProjectService.Extensions;using ProjectService.Validators;using Xunit;namespace ProjectService.Tests;public class AdminProjectsControllerTests{    private readonly AppDb _db;    private readonly AdminProjectsController _controller;    public AdminProjectsControllerTests(){        var options = new DbContextOptionsBuilder<AppDb>().UseInMemoryDatabase(Guid.NewGuid().ToString()).Options;        _db = new AppDb(options);        _controller = new AdminProjectsController(_db, new ApproveProjectRequestValidator(), new CreateProjectTaskRequestValidator());        var claims = new[] { new Claim("sub", "500"), new Claim("role", "admin") };        _controller.ControllerContext = new ControllerContext { HttpContext = new DefaultHttpContext { User = new ClaimsPrincipal(new ClaimsIdentity(claims, "test")) } };    }    [Fact]    public async Task GetProjects_FiltersByStatus(){        _db.Projects.AddRange(new Project{ProjectId=Guid.NewGuid(), Title="A", Status=ProjectStatus.PendingReview, CreatedAt=DateTimeOffset.UtcNow.AddMinutes(-2), UpdatedAt=DateTimeOffset.UtcNow.AddMinutes(-2)}, new Project{ProjectId=Guid.NewGuid(), Title="B", Status=ProjectStatus.Approved, CreatedAt=DateTimeOffset.UtcNow.AddMinutes(-1), UpdatedAt=DateTimeOffset.UtcNow.AddMinutes(-1)});        await _db.SaveChangesAsync();        var result = await _controller.GetProjects(ProjectStatus.Approved, CancellationToken.None);        var ok = result.Result as OkObjectResult;        ok.Should().NotBeNull();        ((IEnumerable<ProjectSummaryDto>)ok!.Value!).Should().HaveCount(1);    }    [Fact]    public async Task ApproveProject_UpdatesStatusAndTasks(){        var p = new Project{ProjectId=Guid.NewGuid(), Title="T", CreatedAt=DateTimeOffset.UtcNow, UpdatedAt=DateTimeOffset.UtcNow};        var task = new ProjectTask{TaskId=Guid.NewGuid(), ProjectId=p.ProjectId, Title="Task", ServiceType="Serv", CreatedAt=DateTimeOffset.UtcNow, UpdatedAt=DateTimeOffset.UtcNow};        p.Tasks.Add(task);        _db.Projects.Add(p);        await _db.SaveChangesAsync();        var req = new ApproveProjectRequest{ ApprovedStart=DateTimeOffset.UtcNow, ApprovedEnd=DateTimeOffset.UtcNow.AddHours(1), Tasks=new List<ApproveProjectTaskUpdate>{ new(){ TaskId=task.TaskId, AssigneeId=900 } } };        var result = await _controller.ApproveProject(p.ProjectId, req, CancellationToken.None);        result.Should().BeOfType<NoContentResult>();        var updated = await _db.Projects.Include(x=>x.Tasks).FirstAsync(x=>x.ProjectId==p.ProjectId);        updated.Status.Should().Be(ProjectStatus.Approved);        updated.Tasks.First().AssigneeId.Should().Be(900);    }    [Fact]    public async Task AddTask_CreatesTask(){        var p = new Project{ProjectId=Guid.NewGuid(), Title="T", CreatedAt=DateTimeOffset.UtcNow, UpdatedAt=DateTimeOffset.UtcNow};        _db.Projects.Add(p);        await _db.SaveChangesAsync();        var req = new CreateProjectTaskRequest{ Title="New Task", ServiceType="Type", Detail="D" };        var result = await _controller.AddTask(p.ProjectId, req, CancellationToken.None);        var created = (result.Result as CreatedAtActionResult)!;        created.Should().NotBeNull();        _db.Tasks.Count(t=>t.ProjectId==p.ProjectId).Should().Be(1);    }}