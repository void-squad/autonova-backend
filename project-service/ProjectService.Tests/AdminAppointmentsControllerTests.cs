using System;using System.Collections.Generic;using System.Linq;using System.Threading;using System.Threading.Tasks;using FluentAssertions;using Microsoft.AspNetCore.Http;using Microsoft.AspNetCore.Mvc;using Microsoft.EntityFrameworkCore;using Microsoft.Extensions.Logging;using Moq;using ProjectService.Controllers;using ProjectService.Data;using ProjectService.Domain.Entities;using ProjectService.Domain.Enums;using ProjectService.Dtos;using ProjectService.Services;using Xunit;namespace ProjectService.Tests;public class AdminAppointmentsControllerTests{    private readonly Mock<IAppointmentServiceClient> _client = new();    private readonly AppDb _db;    private readonly AdminAppointmentsController _controller;    public AdminAppointmentsControllerTests(){        var options = new DbContextOptionsBuilder<AppDb>()            .UseInMemoryDatabase(Guid.NewGuid().ToString())            .Options;        _db = new AppDb(options);        var logger = new Mock<ILogger<AdminAppointmentsController>>();        _controller = new AdminAppointmentsController(_client.Object, _db, logger.Object);        _controller.ControllerContext = new ControllerContext{            HttpContext = new DefaultHttpContext()        };    }    [Fact]    public async Task GetAppointment_ReturnsNotFound_WhenNull(){        _client.Setup(c => c.GetAppointmentAsync(It.IsAny<Guid>(), It.IsAny<CancellationToken>()))            .ReturnsAsync((ExternalAppointmentDto?)null);        var result = await _controller.GetAppointment(Guid.NewGuid(), CancellationToken.None);        result.Should().BeOfType<NotFoundResult>();    }    [Fact]    public async Task ConvertToProject_CreatesProject_WhenNoExistingProject(){        var appt = new ExternalAppointmentDto{            Id = Guid.NewGuid(),            CustomerId = Guid.NewGuid(),            VehicleId = Guid.NewGuid(),            ServiceType = "Brake Service",            Notes = "Check pads",            StartTime = DateTimeOffset.UtcNow,            EndTime = DateTimeOffset.UtcNow.AddHours(2),            Status = "CONFIRMED"        };        _client.Setup(c => c.GetAppointmentAsync(appt.Id, It.IsAny<CancellationToken>()))            .ReturnsAsync(appt);        var response = await _controller.ConvertToProject(appt.Id, null, CancellationToken.None);        response.Result.Should().BeOfType<CreatedAtActionResult>();        _db.Projects.Count().Should().Be(1);        var project = _db.Projects.Include(p=>p.Tasks).First();        project.VehicleId.Should().Be(appt.VehicleId);        project.Tasks.Should().HaveCount(1);    }    [Fact]    public async Task ConvertToProject_Conflict_WhenProjectExistsForVehicle(){        var vehicleId = Guid.NewGuid();        var existing = new Project{ ProjectId = Guid.NewGuid(), VehicleId = vehicleId, Title = "Existing", CreatedAt = DateTimeOffset.UtcNow, UpdatedAt = DateTimeOffset.UtcNow };        _db.Projects.Add(existing);        await _db.SaveChangesAsync();        var appt = new ExternalAppointmentDto{            Id = Guid.NewGuid(),            CustomerId = Guid.NewGuid(),            VehicleId = vehicleId,            ServiceType = "Oil Change",            Notes = "Synthetic",            StartTime = DateTimeOffset.UtcNow,            EndTime = DateTimeOffset.UtcNow.AddHours(1),            Status = "CONFIRMED"        };        _client.Setup(c => c.GetAppointmentAsync(appt.Id, It.IsAny<CancellationToken>()))            .ReturnsAsync(appt);        var result = await _controller.ConvertToProject(appt.Id, null, CancellationToken.None);        result.Result.Should().BeOfType<ConflictObjectResult>();    }    [Fact]    public async Task ConvertToProject_AddsTask_WhenExistingProjectProvided(){        var project = new Project{ ProjectId = Guid.NewGuid(), VehicleId = Guid.NewGuid(), Title = "Existing", CreatedAt = DateTimeOffset.UtcNow, UpdatedAt = DateTimeOffset.UtcNow };        _db.Projects.Add(project);        await _db.SaveChangesAsync();        var appt = new ExternalAppointmentDto{            Id = Guid.NewGuid(),            CustomerId = Guid.NewGuid(),            VehicleId = project.VehicleId,            ServiceType = "Tune",            Notes = "ECU",            StartTime = DateTimeOffset.UtcNow,            EndTime = DateTimeOffset.UtcNow.AddHours(3),            Status = "CONFIRMED"        };        _client.Setup(c => c.GetAppointmentAsync(appt.Id, It.IsAny<CancellationToken>()))            .ReturnsAsync(appt);        var req = new ConvertAppointmentRequest{ ProjectId = project.ProjectId };        var result = await _controller.ConvertToProject(appt.Id, req, CancellationToken.None);        result.Result.Should().BeOfType<OkObjectResult>();        _db.Tasks.Count(t=>t.ProjectId==project.ProjectId).Should().Be(1);    }}