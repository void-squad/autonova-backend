using System;using System.Collections.Generic;using System.Linq;using System.Security.Claims;using System.Threading;using System.Threading.Tasks;using FluentAssertions;using Microsoft.AspNetCore.Http;using Microsoft.AspNetCore.Mvc;using Microsoft.EntityFrameworkCore;using ProjectService.Controllers;using ProjectService.Data;using ProjectService.Domain.Entities;using ProjectService.Domain.Enums;using ProjectService.Dtos;using ProjectService.Validators;using Xunit;namespace ProjectService.Tests;public class ProjectsControllerTests{    private readonly AppDb _db;    private readonly ProjectsController _controller;    public ProjectsControllerTests(){        var options = new DbContextOptionsBuilder<AppDb>().UseInMemoryDatabase(Guid.NewGuid().ToString()).Options;        _db = new AppDb(options);        _controller = new ProjectsController(_db, new CreateProjectRequestValidator());        var claims = new[] { new Claim("sub", "700"), new Claim("role", "customer") };        _controller.ControllerContext = new ControllerContext { HttpContext = new DefaultHttpContext { User = new ClaimsPrincipal(new ClaimsIdentity(claims, "test")) } };    }    [Fact]    public async Task CreateProject_CreatesDefaultTask_WhenNoTasksProvided(){        var req = new CreateProjectRequest{ VehicleId=Guid.NewGuid(), Title="Project", Description="Desc" };        var result = await _controller.CreateProject(req, CancellationToken.None);        var created = (result.Result as CreatedAtActionResult)!;        created.Should().NotBeNull();        var dto = (ProjectDetailsDto)created.Value!;        dto.Tasks.Should().HaveCount(1);        dto.Title.Should().Be("Project");    }    [Fact]    public async Task CancelProject_SetsCancelledStatus(){        var p = new Project{ProjectId=Guid.NewGuid(), CustomerId=700, VehicleId=Guid.NewGuid(), Title="P", Status=ProjectStatus.PendingReview, CreatedAt=DateTimeOffset.UtcNow, UpdatedAt=DateTimeOffset.UtcNow};        _db.Projects.Add(p);        await _db.SaveChangesAsync();        var result = await _controller.CancelProject(p.ProjectId, CancellationToken.None);        result.Should().BeOfType<NoContentResult>();        (await _db.Projects.FirstAsync(x=>x.ProjectId==p.ProjectId)).Status.Should().Be(ProjectStatus.Cancelled);    }}