package com.autonova.payments_billing_service.service;import com.autonova.payments_billing_service.config.StripeProperties;import com.autonova.payments_billing_service.domain.*;import com.autonova.payments_billing_service.messaging.DomainEventPublisher;import com.autonova.payments_billing_service.repository.PaymentRepository;import org.junit.jupiter.api.BeforeEach;import org.junit.jupiter.api.Test;import org.junit.jupiter.api.extension.ExtendWith;import org.mockito.ArgumentCaptor;import org.mockito.InjectMocks;import org.mockito.Mock;import org.mockito.junit.jupiter.MockitoExtension;import java.util.Optional;import java.util.UUID;import static org.assertj.core.api.Assertions.assertThat;import static org.mockito.ArgumentMatchers.any;import static org.mockito.Mockito.*;@ExtendWith(MockitoExtension.class)class PaymentServiceOfflineRecordTest {    @Mock StripeProperties props;    @Mock PaymentRepository paymentRepository;    @Mock DomainEventPublisher publisher;    @Mock InvoiceService invoiceService;    @InjectMocks PaymentService paymentService;    @BeforeEach void setup(){ when(props.getApiKey()).thenReturn("sk_test_key"); }    @Test void recordOfflinePayment_createsEntityAndPublishes(){        InvoiceEntity invoice = new InvoiceEntity();        invoice.setId(UUID.randomUUID());        invoice.setProjectId(UUID.randomUUID());        invoice.setCustomerEmail("c@example.com");        invoice.setCustomerUserId(10L);        invoice.setCurrency("lkr");        invoice.setAmountTotal(5000L);        invoice.setStatus(InvoiceStatus.OPEN);        when(paymentRepository.findFirstByInvoice_IdAndStatusOrderByCreatedAtDesc(invoice.getId(), PaymentStatus.SUCCEEDED))            .thenReturn(Optional.empty());        when(paymentRepository.save(any(PaymentEntity.class))).thenAnswer(inv -> inv.getArgument(0));        paymentService.recordOfflinePayment(invoice, null);        ArgumentCaptor<PaymentEntity> captor = ArgumentCaptor.forClass(PaymentEntity.class);        verify(paymentRepository).save(captor.capture());        PaymentEntity saved = captor.getValue();        assertThat(saved.getProvider()).isEqualTo(PaymentProvider.OFFLINE);        assertThat(saved.getStatus()).isEqualTo(PaymentStatus.SUCCEEDED);        verify(invoiceService).markInvoicePaid(invoice);        verify(publisher).publishPaymentSucceeded(eq(invoice), any(PaymentEntity.class));    }}