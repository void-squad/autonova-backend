services:
  # Local DB commented out as we are using Neon/Postgres Cloud
  # postgres:
  #  container_name: autonova-postgres
  #  image: postgres:17
  #  environment:
  #    POSTGRES_USER: ${POSTGRES_USER}
  #    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  #    PROJECTS_DB_PASSWORD: ${PROJECTS_DB_PASSWORD}
  #    PROGRESS_MONITORING_DB_PASSWORD: ${PROGRESS_MONITORING_DB_PASSWORD}
  #  ports:
  #    - "5432:5432"
  #  volumes:
  #    - postgres_data:/var/lib/postgresql/data
  #  healthcheck:
  #    test: ["CMD-SHELL", "pg_isready -U postgres"]
  #    interval: 5s
  #    retries: 5

  postgres-init:
    image: postgres:17
    # depends_on:
    #  - postgres # Commented out since we're using cloud Postgres
    environment:
      PGHOST: ${POSTGRES_HOST}
      PGPORT: ${POSTGRES_PORT}
      PGDATABASE: ${PGDATABASE}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PROJECTS_DB_PASSWORD: ${PROJECTS_DB_PASSWORD}
      PROGRESS_MONITORING_DB_PASSWORD: ${PROGRESS_MONITORING_DB_PASSWORD}
      EMPLOYEE_DASHBOARD_DB_PASSWORD: ${EMPLOYEE_DASHBOARD_DB_PASSWORD}
      TIME_LOGGING_DB_PASSWORD: ${TIME_LOGGING_DB_PASSWORD}
      USER_MANAGEMENT_DB_PASSWORD: ${USER_MANAGEMENT_DB_PASSWORD}
      NOTIFICATION_DB_PASSWORD: ${NOTIFICATION_DB_PASSWORD} # Added from dev
      VECTOR_DB_PASSWORD: ${VECTOR_DB_PASSWORD} # Added from dev
      PBS_DB_PASSWORD: ${PBS_DB_PASSWORD:-payments_billing_service}
      ANALYTICS_DB_PASSWORD: ${ANALYTICS_DB_PASSWORD}
    volumes:
      - ./init-scripts:/scripts:ro
    # Run mounted init scripts after stripping Windows CRLFs and using bash
    # Use $$ to escape environment variable interpolation inside the compose file.
    entrypoint:
      [
        "sh",
        "-c",
        "echo 'Waiting for PostgreSQL at $PGHOST:$PGPORT...'; until pg_isready -h $$PGHOST -U $$POSTGRES_USER; do sleep 2; done; echo 'Starting pgvector extension setup...'; tr -d '\\r' </scripts/pgvector-init.sh | bash -s --; echo 'Starting database initialization via db-init.sh'; tr -d '\\r' </scripts/db-init.sh | bash -s --",
      ]
    restart: "no"

  rabbitmq:
    container_name: autonova-rabbitmq
    image: rabbitmq:4.1.4-management
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 5s
      retries: 5
    networks:
      - autonova-network

  # # Ollama local model server for LLM testing
  # ollama:
  #   container_name: autonova-ollama
  #   image: ollama/ollama:latest
  #   ports:
  #     - "11434:11434"
  #   volumes:
  #     - ./ollama-data:/root/.ollama
  #     - ./init-scripts:/scripts:ro
  #   entrypoint: ["sh", "-c", "tr -d '\\r' </scripts/ollama-init.sh | sh -s --"]
  #   restart: "no"
  #   networks:
  #     - autonova-network

  # --- New Service: Discovery Service (from dev) ---
  discovery-service:
    container_name: autonova-discovery-service
    build:
      # Use repository root as build context so the parent POM (../pom.xml)
      # is available to Maven during the image build. The Dockerfile path
      # points to the service's Dockerfile inside the repo.
      context: ..
      dockerfile: discovery-service/Dockerfile
    ports:
      - "8761:8761"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-default}
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8761/actuator/health",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    networks:
      - autonova-network

  auth-service:
    container_name: autonova-auth-service
    build:
      #      context: ../auth-service
      #      dockerfile: Dockerfile.prebuilt # Uses pre-built JAR (much faster!)
      #      dockerfile: Dockerfile

      context: .. # This points to project root (one level up from infra/)
      dockerfile: auth-service/Dockerfile
    ports:
      - "8081:8081" # Map host 8082 to container 8081
    environment:
      # Database Configuration (using cloud Neon PostgreSQL)
      DB_URL: jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/user_management_db
      DB_USERNAME: auth_user
      DB_PASSWORD: ${USER_MANAGEMENT_DB_PASSWORD}

      # JWT Configuration
      JWT_SECRET: ${JWT_SECRET}

      # Email Configuration
      EMAIL_USERNAME: ${EMAIL_USERNAME}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD}

      # OAuth2 Configuration
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}

      # Frontend URL
      FRONTEND_URL: ${FRONTEND_URL}

      # Spring Profile
      SPRING_PROFILES_ACTIVE: docker

      # Server port (running on 8081 inside container)
      SERVER_PORT: 8081
    depends_on:
      - postgres-init
      - rabbitmq
      - discovery-service # Added dependency on discovery service
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8081/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - autonova-network

  customer-service:
    container_name: autonova-customer-service
    build:
      context: ..
      dockerfile: customer-service/Dockerfile
    ports:
      - "8087:8087"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-default}
      CUSTOMER_SERVICE_DB_URL: "${CUSTOMER_SERVICE_DB_URL:-jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/customer_service}"
      CUSTOMER_SERVICE_DB_USERNAME: ${CUSTOMER_SERVICE_DB_USERNAME:-customer_service}
      CUSTOMER_SERVICE_DB_PASSWORD: ${CUSTOMER_SERVICE_DB_PASSWORD:-customer_service}
      CUSTOMER_SERVICE_PORT: 8087
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
      RABBITMQ_PORT: ${RABBITMQ_PORT:-5672}
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-guest}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-guest}
      EUREKA_SERVER_URL: "${EUREKA_SERVER_URL:-http://discovery-service:8761/eureka/}"
      CUSTOMER_EVENTS_EXCHANGE: ${CUSTOMER_EVENTS_EXCHANGE:-customer.events}
      AUTH_EVENTS_EXCHANGE: ${AUTH_EVENTS_EXCHANGE:-auth.events}
      AUTH_EVENTS_LOGIN_QUEUE: ${AUTH_EVENTS_LOGIN_QUEUE:-customer-service.auth.user-login}
      AUTH_EVENTS_LOGIN_ROUTING: ${AUTH_EVENTS_LOGIN_ROUTING:-user.logged-in}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      - postgres-init
      - rabbitmq
      - discovery-service
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8087/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - autonova-network

  gateway-service:
    container_name: autonova-gateway-service
    build:
      # Use repository root as build context so the parent POM (../pom.xml)
      # is available during the image build. Point dockerfile at the service
      # Dockerfile inside the repo.
      context: ..
      dockerfile: gateway-service/Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-default}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL:-http://auth-service:8081}
      CUSTOMER_SERVICE_URL: ${CUSTOMER_SERVICE_URL:-http://customer-service:8087}
      PROJECT_SERVICE_URL: ${PROJECT_SERVICE_URL:-http://project-service:8082}
      PROGRESS_MONITORING_SERVICE_URL: ${PROGRESS_MONITORING_SERVICE_URL:-http://progress-monitoring:8086}
      NOTIFICATION_SERVICE_URL: ${NOTIFICATION_SERVICE_URL:-http://notification-service:8085}
      PAYMENTS_BILLING_SERVICE_URL: ${PAYMENTS_BILLING_SERVICE_URL:-http://payments-billing-service:8069}
      APPOINTMENT_BOOKING_SERVICE_URL: ${APPOINTMENT_BOOKING_SERVICE_URL:-http://appointment-booking-service:8088}
      EMPLOYEE_DASHBOARD_SERVICE_URL: ${EMPLOYEE_DASHBOARD_SERVICE_URL:-http://employee-dashboard-service:8084}
      TIME_LOGGING_SERVICE_URL: ${TIME_LOGGING_SERVICE_URL:-http://time-logging-service:8083}
      CHATBOT_SERVICE_URL: ${CHATBOT_SERVICE_URL:-http://chatbot:8097}
    ports:
      - "8080:8080"
    depends_on:
      - discovery-service
    networks:
      - autonova-network

  employee-dashboard-service:
    container_name: autonova-employee-dashboard-service
    build:
      context: ..
      dockerfile: employee-dashboard-service/Dockerfile
    ports:
      - "8084:8084"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-service:8761/eureka/
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-86400000}
      SERVICES_GATEWAY_URL: http://gateway-service:8080
      JAVA_OPTS: -Xms256m -Xmx512m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
    depends_on:
      - gateway-service
      - discovery-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - autonova-network

  project-service:
    container_name: autonova-project-service
    build:
      context: ../project-service
    environment:
      ConnectionStrings__Postgres: Host=${POSTGRES_HOST};Database=projects_db;Username=project_service;Password=${PROJECTS_DB_PASSWORD}
      Auth__Authority: http://auth-service:8081 # Changed from 8082 to 8081 (auth container port)
      Rabbit__HostName: rabbitmq
      Rabbit__UserName: guest
      Rabbit__Password: guest
      Rabbit__Exchange: autonova.events
      Eureka__Client__ServiceUrl: http://discovery-service:8761/eureka/
      ASPNETCORE_URLS: http://+:8082
    ports:
      - "8082:8082"
    depends_on:
      - postgres-init
      - rabbitmq
      - auth-service
      - discovery-service # Added dependency on discovery service
    networks:
      - autonova-network

  progress-monitoring:
    container_name: autonova-progress-monitoring
    build:
      context: ../progress-monitoring-service
    environment:
      SERVER_PORT: 8086
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${PROGRESS_MONITORING_DB_PASSWORD}
      POSTGRES_DB: progress
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      APP_RABBIT_EXCHANGE: autonova.events
      APP_RABBIT_QUEUE: progress.project.queue
      APP_RABBIT_ROUTING_KEYS: "project.*,quote.*,project.change-request.*"
      JWT_SECRET: ${JWT_SECRET}
      JAVA_OPTS: -Xms256m -Xmx512m
    ports:
      - "8086:8086"
    depends_on:
      - rabbitmq
      - postgres-init
      - discovery-service
    networks:
      - autonova-network

  # --- New Service: Notification Service (from dev) ---
  notification-service:
    container_name: autonova-notification-service
    build:
      context: ../notification-service
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      APP_RABBIT_EXCHANGE: autonova.events
      APP_RABBIT_QUEUE: notification.events.queue
      APP_RABBIT_ROUTING_KEY: "#"
      DB_HOST: ${POSTGRES_HOST}
      DB_PORT: ${POSTGRES_PORT}
      DB_USER: notification_service
      DB_PASSWORD: ${NOTIFICATION_DB_PASSWORD}
      # SSL mode for JDBC: default to disable for local; set DB_SSLMODE=require when using Neon/cloud
      DB_SSLMODE: ${DB_SSLMODE:-disable}
    ports:
      - "8085:8085"
    depends_on:
      - rabbitmq
      - postgres-init
      - discovery-service # Added dependency on discovery service
    networks:
      - autonova-network

  time-logging-service:
    container_name: autonova-time-logging-service
    build:
      context: ..
      dockerfile: time-logging-service/Dockerfile
    ports:
      - "8083:8083"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-default}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${TIME_LOGGING_DB_PASSWORD}
      PGDATABASE: time_logging_db
    depends_on:
      - postgres-init
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8083/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - autonova-network

  appointment-booking-service:
    container_name: autonova-appointment-booking-service
    build:
      context: ..
      dockerfile: appointment-booking-service/Dockerfile
    ports:
      - "8088:8088"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-default}
      SERVER_PORT: 8088
    depends_on:
      - postgres-init
      - discovery-service
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8088/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - autonova-network

  employee-dashboard-service:
    container_name: autonova-employee-dashboard-service
    build:
      context: ..
      dockerfile: employee-dashboard-service/Dockerfile
    ports:
      - "8084:8084"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-default}
      JWT_SECRET: ${JWT_SECRET}
      EUREKA_SERVER_URL: ${EUREKA_SERVER_URL:-http://discovery-service:8761/eureka/}
      SERVICES_GATEWAY_URL: http://gateway-service:8080
      SERVICES_CUSTOMER_URL: ${CUSTOMER_SERVICE_URL:-http://customer-service:8087}
      SERVICES_APPOINTMENT_URL: ${APPOINTMENT_BOOKING_SERVICE_URL:-http://appointment-booking-service:8088}
      SERVICES_PROJECT_URL: ${PROJECT_SERVICE_URL:-http://project-service:8082}
      SERVICES_PAYMENT_URL: ${PAYMENTS_BILLING_SERVICE_URL:-http://payments-billing-service:8069}
      SERVICES_PROGRESS_URL: ${PROGRESS_MONITORING_SERVICE_URL:-http://progress-monitoring:8086}
    depends_on:
      - discovery-service
      - gateway-service
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8084/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - autonova-network

  payments-billing-service:
    container_name: autonova-payments-billing-service
    build:
      context: ..
      dockerfile: payments-billing-service/Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-default}
      SERVER_PORT: ${PBS_SERVER_PORT:-8069}
      PBS_DB_URL: ${PBS_DB_URL:-jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/payments_billing_db}
      PBS_DB_USERNAME: ${PBS_DB_USERNAME:-payments_billing_service}
      PBS_DB_PASSWORD: ${PBS_DB_PASSWORD:-payments_billing_service}
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
      RABBITMQ_PORT: ${RABBITMQ_PORT:-5672}
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-guest}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-guest}
      STRIPE_API_KEY: ${STRIPE_API_KEY:-sk_test_placeholder}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-whsec_placeholder}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-pk_test_placeholder}
      STRIPE_WEBHOOK_ENDPOINT_SECRET: ${STRIPE_WEBHOOK_ENDPOINT_SECRET:-whsec_endpoint_placeholder}
      AUTH_JWT_HS256_SECRET: ${AUTH_JWT_HS256_SECRET:-change-me}
      PBS_INVOICE_EXCHANGE: ${PBS_INVOICE_EXCHANGE:-billing.invoice}
      PBS_PAYMENT_EXCHANGE: ${PBS_PAYMENT_EXCHANGE:-billing.payment}
    ports:
      - "${PBS_SERVER_PORT:-8069}:${PBS_SERVER_PORT:-8069}"
    depends_on:
      - postgres-init
      - rabbitmq
    networks:
      - autonova-network
  analytics-service:
    container_name: autonova-analytics-service
    build:
      context: ..
      dockerfile: analytics-service/Dockerfile
    ports:
      - '8089:8089'
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-default}

      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/analytics_db
      SPRING_DATASOURCE_USERNAME: analytics_service
      SPRING_DATASOURCE_PASSWORD: ${ANALYTICS_DB_PASSWORD}

      # Other Microservices URLs (using internal container names and ports)
      SERVICES_CUSTOMER_URL: http://customer-service:8087
      SERVICES_AUTH_URL: http://auth-service:8081
      SERVICES_PROJECT_URL: http://project-service:8082
      SERVICES_PAYMENT_URL: http://payments-billing-service:${PBS_SERVER_PORT:-8069}
      SERVICES_NOTIFICATION_URL: http://notification-service:8084

      # RabbitMQ Configuration
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-guest}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-guest}

      # Discovery Service (Eureka)
      EUREKA_SERVER_URL: ${EUREKA_SERVER_URL:-http://discovery-service:8761/eureka/}

      # Server Port
      SERVER_PORT: 8089
    depends_on:
      - postgres-init
      - rabbitmq
      - discovery-service
      - auth-service
      - customer-service
      - project-service
      - payments-billing-service
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--no-verbose',
          '--tries=1',
          '--spider',
          'http://localhost:8085/api/analytics/health',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - autonova-network

  # Chatbot service
  chatbot:
    container_name: autonova-chatbot
    build:
      # Use repository root as build context so parent POM and shared config are available
      context: ../chatbot
      dockerfile: Dockerfile
    env_file:
      - ../chatbot/.env
    ports:
      - "8097:8097"
    depends_on:
      - rabbitmq
      - postgres-init
    networks:
      - autonova-network
    restart: "no"

volumes:
  postgres_data:
    name: autonova_postgres_data

networks:
  autonova-network:
    driver: bridge
