services:
  # Local DB commented out as we are using Neon/Postgres Cloud
  # postgres:
  #  container_name: autonova-postgres
  #  image: postgres:17
  #  environment:
  #    POSTGRES_USER: ${POSTGRES_USER}
  #    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  #    PROJECTS_DB_PASSWORD: ${PROJECTS_DB_PASSWORD}
  #    PROGRESS_MONITORING_DB_PASSWORD: ${PROGRESS_MONITORING_DB_PASSWORD}
  #  ports:
  #    - "5432:5432"
  #  volumes:
  #    - postgres_data:/var/lib/postgresql/data
  #  healthcheck:
  #    test: ["CMD-SHELL", "pg_isready -U postgres"]
  #    interval: 5s
  #    retries: 5

  postgres-init:
    image: postgres:17
    # depends_on:
    #  - postgres # Commented out since we're using cloud Postgres
    environment:
      PGHOST: ${POSTGRES_HOST}
      PGPORT: ${POSTGRES_PORT}
      PGDATABASE: ${PGDATABASE}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PROJECTS_DB_PASSWORD: ${PROJECTS_DB_PASSWORD}
      PROGRESS_MONITORING_DB_PASSWORD: ${PROGRESS_MONITORING_DB_PASSWORD}
      EMPLOYEE_DASHBOARD_DB_PASSWORD: ${EMPLOYEE_DASHBOARD_DB_PASSWORD}
      TIME_LOGGING_DB_PASSWORD: ${TIME_LOGGING_DB_PASSWORD}
      USER_MANAGEMENT_DB_PASSWORD: ${USER_MANAGEMENT_DB_PASSWORD}
      NOTIFICATION_DB_PASSWORD: ${NOTIFICATION_DB_PASSWORD} # Added from dev
      VECTOR_DB_PASSWORD: ${VECTOR_DB_PASSWORD} # Added from dev
    volumes:
      - ./init-scripts:/scripts:ro
    entrypoint: >
      bash -c "
        echo 'Waiting for PostgreSQL at $PGHOST:$PGPORT...';
        until pg_isready -h $$PGHOST -U $$POSTGRES_USER; do
          sleep 2;
        done;
        echo 'Starting pgvector extension setup...'; # Added from dev
        bash /scripts/pgvector-init.sh; # Added from dev
        echo 'Starting database initialization via db-init.sh';
        bash /scripts/db-init.sh
      "
    restart: 'no'

  rabbitmq:
    container_name: autonova-rabbitmq
    image: rabbitmq:4.1.4-management
    ports:
      - '5672:5672'
      - '15672:15672'
    healthcheck:
      test: ['CMD', 'rabbitmqctl', 'status']
      interval: 5s
      retries: 5
    networks:
      - autonova-network

  # --- New Service: Discovery Service (from dev) ---
  discovery-service:
    container_name: autonova-discovery-service
    build:
      # Use repository root as build context so the parent POM (../pom.xml)
      # is available to Maven during the image build. The Dockerfile path
      # points to the service's Dockerfile inside the repo.
      context: ..
      dockerfile: discovery-service/Dockerfile
    ports:
      - '8761:8761'
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-default}
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--no-verbose',
          '--tries=1',
          '--spider',
          'http://localhost:8761/actuator/health',
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    networks:
      - autonova-network

  auth-service:
    container_name: autonova-auth-service
    build:
      context: ../auth-service
      dockerfile: Dockerfile.prebuilt # Uses pre-built JAR (much faster!)
    ports:
      - '8081:8081' # Map host 8082 to container 8081
    environment:
      # Database Configuration (using cloud Neon PostgreSQL)
      DB_URL: jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/user_management_db
      DB_USERNAME: auth_user
      DB_PASSWORD: ${USER_MANAGEMENT_DB_PASSWORD}

      # JWT Configuration
      JWT_SECRET: ${JWT_SECRET}

      # Email Configuration
      EMAIL_USERNAME: ${EMAIL_USERNAME}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD}

      # OAuth2 Configuration
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}

      # Frontend URL
      FRONTEND_URL: ${FRONTEND_URL}

      # Spring Profile
      SPRING_PROFILES_ACTIVE: docker

      # Server port (running on 8081 inside container)
      SERVER_PORT: 8081
    depends_on:
      - postgres-init
      - rabbitmq
      - discovery-service # Added dependency on discovery service
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--no-verbose',
          '--tries=1',
          '--spider',
          'http://localhost:8081/actuator/health',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - autonova-network

  customer-service:
    container_name: autonova-customer-service
    build:
      context: ..
      dockerfile: customer-service/Dockerfile
    ports:
      - '8087:8087'
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-default}
      CUSTOMER_SERVICE_DB_URL: '${CUSTOMER_SERVICE_DB_URL:-jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/customer_service}'
      CUSTOMER_SERVICE_DB_USERNAME: ${CUSTOMER_SERVICE_DB_USERNAME:-customer_service}
      CUSTOMER_SERVICE_DB_PASSWORD: ${CUSTOMER_SERVICE_DB_PASSWORD:-customer_service}
      CUSTOMER_SERVICE_PORT: 8087
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
      RABBITMQ_PORT: ${RABBITMQ_PORT:-5672}
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-guest}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-guest}
      EUREKA_SERVER_URL: '${EUREKA_SERVER_URL:-http://discovery-service:8761/eureka/}'
      CUSTOMER_EVENTS_EXCHANGE: ${CUSTOMER_EVENTS_EXCHANGE:-customer.events}
      AUTH_EVENTS_EXCHANGE: ${AUTH_EVENTS_EXCHANGE:-auth.events}
      AUTH_EVENTS_LOGIN_QUEUE: ${AUTH_EVENTS_LOGIN_QUEUE:-customer-service.auth.user-login}
      AUTH_EVENTS_LOGIN_ROUTING: ${AUTH_EVENTS_LOGIN_ROUTING:-user.logged-in}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      - postgres-init
      - rabbitmq
      - discovery-service
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--no-verbose',
          '--tries=1',
          '--spider',
          'http://localhost:8087/actuator/health',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - autonova-network

  gateway-service:
    container_name: autonova-gateway-service
    build:
      # Use repository root as build context so the parent POM (../pom.xml)
      # is available during the image build. Point dockerfile at the service
      # Dockerfile inside the repo.
      context: ..
      dockerfile: gateway-service/Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-default}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL:-http://auth-service:8081} # Auth internal port
      CUSTOMER_SERVICE_URL: ${CUSTOMER_SERVICE_URL:-http://customer-service:8087}
      PROJECT_SERVICE_URL: ${PROJECT_SERVICE_URL:-http://project-service:8082} # Project internal port
    ports:
      - '8080:8080'
    depends_on:
      - discovery-service
    networks:
      - autonova-network

  project-service:
    container_name: autonova-project-service
    build:
      context: ../project-service
    environment:
      ConnectionStrings__Postgres: Host=${POSTGRES_HOST};Database=projects_db;Username=project_service;Password=${PROJECTS_DB_PASSWORD}
      Auth__Authority: http://auth-service:8081 # Changed from 8082 to 8081 (auth container port)
      Rabbit__HostName: rabbitmq
      Rabbit__UserName: guest
      Rabbit__Password: guest
      Rabbit__Exchange: autonova.events
      ASPNETCORE_URLS: http://+:8082
    ports:
      - '8082:8082'
    depends_on:
      - postgres-init
      - rabbitmq
      - auth-service
      - discovery-service # Added dependency on discovery service
    networks:
      - autonova-network

  progress-monitoring:
    container_name: autonova-progress-monitoring
    build:
      context: ../progress-monitoring-service
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      APP_RABBIT_EXCHANGE: autonova.events
      APP_RABBIT_QUEUE: progress.project.queue
      APP_RABBIT_ROUTING_KEY: project.*
      JAVA_OPTS: -Xms256m -Xmx512m
    ports:
      - '8086:8080' # Used 8086 from dev, mapping to container 8080
    depends_on:
      - rabbitmq
      - discovery-service # Added dependency on discovery service
    networks:
      - autonova-network

  # --- New Service: Notification Service (from dev) ---
  notification-service:
    container_name: autonova-notification-service
    build:
      context: ../notification-service
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      APP_RABBIT_EXCHANGE: autonova.events
      APP_RABBIT_QUEUE: notification.events.queue
      APP_RABBIT_ROUTING_KEY: '#'
      DB_HOST: ${POSTGRES_HOST}
      DB_PORT: ${POSTGRES_PORT}
      DB_USER: notification_service
      DB_PASSWORD: ${NOTIFICATION_DB_PASSWORD}
      # SSL mode for JDBC: default to disable for local; set DB_SSLMODE=require when using Neon/cloud
      DB_SSLMODE: ${DB_SSLMODE:-disable}
    ports:
      - '8084:8084'
    depends_on:
      - rabbitmq
      - postgres-init
      - discovery-service # Added dependency on discovery service
    networks:
      - autonova-network

volumes:
  postgres_data:
    name: autonova_postgres_data

networks:
  autonova-network:
    driver: bridge
