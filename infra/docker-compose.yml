services:
  # Local DB commented out as we are using Neon/Postgres Cloud
  # postgres:
  #   container_name: autonova-postgres
  #   image: postgres:17
  #   environment:
  #     POSTGRES_USER: ${POSTGRES_USER}
  #     POSTGRES_PASSWORD:  ${POSTGRES_PASSWORD}
  #     PROJECTS_DB_PASSWORD: ${PROJECTS_DB_PASSWORD}
  #     PROGRESS_MONITORING_DB_PASSWORD: ${PROGRESS_MONITORING_DB_PASSWORD}
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 5s
  #     retries: 5

  postgres-init:
    image: postgres:17
    
    # depends_on:
    #   - postgres  # Commented out since we're using cloud Postgres
    environment:
      PGHOST: ${POSTGRES_HOST}
      PGPORT: ${POSTGRES_PORT}
      PGDATABASE: ${PGDATABASE}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PROJECTS_DB_PASSWORD: ${PROJECTS_DB_PASSWORD}
      PROGRESS_MONITORING_DB_PASSWORD: ${PROGRESS_MONITORING_DB_PASSWORD}
      EMPLOYEE_DASHBOARD_DB_PASSWORD: ${EMPLOYEE_DASHBOARD_DB_PASSWORD}
      USER_MANAGEMENT_DB_PASSWORD: ${USER_MANAGEMENT_DB_PASSWORD}
      NOTIFICATION_DB_PASSWORD: ${NOTIFICATION_DB_PASSWORD}
    volumes:
      - ./init-scripts:/scripts:ro
    entrypoint: >
      bash -c "
        echo 'Waiting for PostgreSQL at $PGHOST:$PGPORT...';
        until pg_isready -h $$PGHOST -U $$POSTGRES_USER; do
          sleep 2;
        done;
        echo 'Starting database initialization via db-init.sh';
        bash /scripts/db-init.sh
      "
    restart: "no"

  rabbitmq:
    container_name: autonova-rabbitmq
    image: rabbitmq:4.1.4-management
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 5s
      retries: 5

  # auth-service:
  #   container_name: autonova-auth-service
  #   build:
  #     context: ../auth-service
  #   ports:
  #     - "8082:8082"
  #   environment:
  #     ConnectionStrings__Postgres: ${AUTH_SERVICE_POSTGRES:-Host=postgres;Database=auth_db;Username=auth_user;Password=auth_pass}
  #   depends_on:
  #     - postgres-init

  discovery-service:
    container_name: autonova-discovery-service
    build:
      context: ../discovery-service
    ports:
      - "8761:8761"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-default}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  gateway-service:
     container_name: autonova-gateway-service
     build:
       context: ../gateway-service
     environment:
       SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-default}
       AUTH_SERVICE_URL: ${AUTH_SERVICE_URL:-http://auth-service:8081}
       CUSTOMER_SERVICE_URL: ${CUSTOMER_SERVICE_URL:-http://customer-service:8083}
       PROJECT_SERVICE_URL: ${PROJECT_SERVICE_URL:-http://project-service:8085}
     ports:
       - "8080:8080"
     depends_on:
       - discovery-service

  project-service:
    container_name: autonova-project-service
    build:
      context: ../services/project-service
    environment:
      ConnectionStrings__Postgres: Host=${POSTGRES_HOST};Database=projects_db;Username=project_service;Password=${PROJECTS_DB_PASSWORD}
      Auth__Authority: http://auth-service:8082
      Rabbit__HostName: rabbitmq
      Rabbit__UserName: guest
      Rabbit__Password: guest
      Rabbit__Exchange: autonova.events
      ASPNETCORE_URLS: http://+:8081
    ports:
      - "8081:8081"
    depends_on:
      # - postgres  # Commented out since we're using cloud Postgres
      - postgres-init
      - rabbitmq

  progress-monitoring:
    container_name: autonova-progress-monitoring
    build:
      context: ../progress-monitoring-service
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      APP_RABBIT_EXCHANGE: autonova.events
      APP_RABBIT_QUEUE: progress.project.queue
      APP_RABBIT_ROUTING_KEY: project.*
      JAVA_OPTS: -Xms256m -Xmx512m
    ports:
      - "8086:8080"
    depends_on:
      - rabbitmq

  notification-service:
    container_name: autonova-notification-service
    build:
      context: ../notification-service
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      APP_RABBIT_EXCHANGE: autonova.events
      APP_RABBIT_QUEUE: notification.events.queue
      APP_RABBIT_ROUTING_KEY: "#"
      DB_HOST: ${POSTGRES_HOST}
      DB_PORT: ${POSTGRES_PORT}
      DB_USER: notification_service
      DB_PASSWORD: ${NOTIFICATION_DB_PASSWORD}
      # SSL mode for JDBC: default to disable for local; set DB_SSLMODE=require when using Neon/cloud
      DB_SSLMODE: ${DB_SSLMODE:-disable}
    ports:
      - "8084:8084"
    depends_on:
      - rabbitmq
      - postgres-init

volumes:
  postgres_data:
    name: autonova_postgres_data
